# InboundEngine システム仕様書

## 1. システム概要
ソーシャルメディア投稿の自動化システム。スプレッドシートで管理された投稿データを、スケジューリングに従って自動投稿し、結果を通知する。

## 2. 主要機能

### 2.1 投稿機能
- 投稿データ管理
  - スプレッドシートによる投稿内容の管理
  - 画像/動画URLの管理
  - 投稿状態の追跡（新規/投稿済/エラー）
  - 投稿回数と最終投稿日時の記録

- 投稿処理
  - テキスト投稿（135-150文字）
  - メディア投稿（画像/動画）
  - 重複投稿防止（ランダムスペース挿入）
  - エラー時のリトライ処理

### 2.2 スケジューラ機能
- 投稿スケジュール
  - 投稿時間帯：9:00-21:00
  - 投稿間隔：平均90分（±15分のゆらぎ）
  - 10分間隔でのチェック

- 優先順位制御
  - 最終投稿日時による優先順位付け
  - 投稿回数による調整
  - 未投稿コンテンツの優先処理

### 2.3 通知機能
#### Discord通知
- 投稿実行通知
  - 投稿内容
  - 投稿URL
  - 投稿時刻
  - ステータス（成功/失敗）

- スケジュール通知
  - 次回投稿予定時刻
  - 投稿予定件数

- エラー通知
  - エラー内容
  - 発生時刻
  - 該当データID
  - スタックトレース（重要エラーの場合）

## 3. データ構造

### 3.1 スプレッドシート
#### 投稿データシート
- 列構成：
  - ID：一意の識別子
  - 投稿日時：投稿実行時刻
  - 本文：投稿テキスト
  - 画像/動画URL：メディアファイルのURL
  - 投稿者：作成者情報
  - 取得日時：データ登録日時
  - ステータス：投稿状態
  - 投稿回数：実行回数
  - 最終投稿日時：最後の投稿実行時刻

### 3.2 設定ファイル（config.yml）
- Twitter API設定
- Discord Webhook URL
- スケジューラ設定
- ログ設定
- 認証情報

## 4. 処理フロー

### 4.1 定期実行フロー
1. cronによる起動（毎時0分）
2. 設定読み込み
3. 投稿可能時間帯チェック
4. 未投稿データの取得
5. 優先順位による投稿データ選択
6. 投稿処理実行
7. 結果の記録と通知

### 4.2 投稿処理フロー
1. 投稿データのバリデーション
2. メディアの事前ダウンロード（必要な場合）
3. Twitter API呼び出し
4. 結果確認
5. スプレッドシート更新
6. Discord通知送信

### 4.3 エラー処理フロー
1. エラー検知
2. リトライ判定
3. リトライ実行（最大3回）
4. エラー記録
5. 通知送信

## 5. 制約事項

### 5.1 API制限
- Twitter API
  - レート制限：100リクエスト/15分
  - メディアサイズ制限：画像5MB、動画512MB
  - 添付メディア数：最大4件

- Google Sheets API
  - 読み取り：100リクエスト/100秒
  - 書き込み：50リクエスト/100秒

### 5.2 運用制約
- 投稿時間帯：9:00-21:00
- 最小投稿間隔：75分（90分-15分）
- 最大投稿間隔：105分（90分+15分）
- 同一コンテンツの最小再投稿間隔：24時間

## 6. 監視と運用

### 6.1 監視項目
- 投稿成功率
- API制限状況
- エラー発生頻度
- 処理遅延状況

### 6.2 バックアップ
- スプレッドシートの自動バックアップ
- エラーログの保存（7日間）
- 設定ファイルの管理

### 6.3 異常時対応
- API制限到達時の待機処理
- ネットワークエラー時のリトライ
- 認証エラー時の通知と停止
- データ不整合時の修復手順 