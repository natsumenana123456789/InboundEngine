name: ğŸ¤– Auto Post Bot with Scheduler

on:
  # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œ
  schedule:
    # æ¯æœ8æ™‚ã«ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç”Ÿæˆï¼ˆJSTï¼‰
    - cron: '0 23 * * *'  # UTC 23:00 = JST 8:00
    # æ¯æ—¥10æ™‚ã€14æ™‚ã€18æ™‚ã€21æ™‚ã«æŠ•ç¨¿å®Ÿè¡Œï¼ˆJSTï¼‰
    - cron: '0 1,5,9,12 * * *'  # UTC 1,5,9,12 = JST 10,14,18,21
  
  # Git pushæ™‚ã®é€šçŸ¥
  push:
    branches: [ main ]
  
  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      action:
        description: 'å®Ÿè¡Œã™ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ (schedule | schedule-now | post)'
        required: true
        default: 'post'
        type: choice
        options:
          - post
          - schedule
          - schedule-now

jobs:
  # Git pushæ™‚ã®Discordé€šçŸ¥
  notify-update:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4 # checkoutã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’v4ã«æ›´æ–°
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10' # ãƒãƒ¼ã‚¸ãƒ§ãƒ³çµ±ä¸€
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    # ã“ã®é€šçŸ¥ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒ‘ã‚¹ã¨å‹•ä½œã¯ç¾çŠ¶ç¶­æŒã€‚å•é¡ŒãŒã‚ã‚Œã°åˆ¥é€”ä¿®æ­£ã€‚
    - name: ğŸ“¢ Discord Pushé€šçŸ¥
      env:
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      run: |
        python bots/auto_post_bot/discord_notifier.py --type push \
          --repo "${{ github.repository }}" \
          --commit "${{ github.event.head_commit.message }}" \
          --author "${{ github.event.head_commit.author.name }}" \
          --branch "${{ github.ref_name }}"

  # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç”Ÿæˆã‚¸ãƒ§ãƒ–
  schedule:
    if: github.event.schedule == '0 23 * * *' || (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'schedule')
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10' # ãƒãƒ¼ã‚¸ãƒ§ãƒ³çµ±ä¸€
        
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸ”§ Create config files from template
      env:
        # --- ã“ã“ã« config/generate_config.py ãŒå¿…è¦ã¨ã™ã‚‹å…¨ã¦ã®secretsã‚’ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦å®šç¾© ---
        # ä¾‹: (å®Ÿéš›ã®secretsåã¯ãƒªãƒã‚¸ãƒˆãƒªã«åˆã‚ã›ã¦ãã ã•ã„)
        # ACCOUNT1_CONSUMER_KEY: ${{ secrets.ACCOUNT1_CONSUMER_KEY }}
        # ACCOUNT1_CONSUMER_SECRET: ${{ secrets.ACCOUNT1_CONSUMER_SECRET }}
        # ACCOUNT1_ACCESS_TOKEN: ${{ secrets.ACCOUNT1_ACCESS_TOKEN }}
        # ACCOUNT1_ACCESS_TOKEN_SECRET: ${{ secrets.ACCOUNT1_ACCESS_TOKEN_SECRET }}
        # ACCOUNT1_BEARER_TOKEN: ${{ secrets.ACCOUNT1_BEARER_TOKEN }} # Optional
        # ACCOUNT2_CONSUMER_KEY: ${{ secrets.ACCOUNT2_CONSUMER_KEY }}
        # ... ä»–ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚„å…±é€šã®secretã‚‚åŒæ§˜ã« ...
        DISCORD_WEBHOOK_URL_SECRET: ${{ secrets.DISCORD_WEBHOOK_URL }} # generate_config.pyå´ã§ã®å‚ç…§åã«åˆã‚ã›ã‚‹
        GOOGLE_SHEETS_KEY_JSON_SECRET: ${{ secrets.GOOGLE_SHEETS_KEY }} # JSONæ–‡å­—åˆ—ã‚’ãã®ã¾ã¾æ¸¡ã™
        # --- ã“ã“ã¾ã§ secrets å®šç¾© ---
      run: |
        mkdir -p config logs
        python config/generate_config.py # ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒ config/config.yml ã¨ config/gspread-key.json ã‚’ç”Ÿæˆã™ã‚‹
        
    - name: ğŸ“… Generate schedule
      run: python main.py --generate-schedule --date $(TZ='Asia/Tokyo' date +%Y-%m-%d)

  # ç¾åœ¨æ™‚åˆ»ã‹ã‚‰ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç”Ÿæˆã‚¸ãƒ§ãƒ– (æ‰‹å‹•å®Ÿè¡Œç”¨)
  schedule-now:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'schedule-now'
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10' # ãƒãƒ¼ã‚¸ãƒ§ãƒ³çµ±ä¸€
        
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸ”§ Create config files from template
      env:
        # --- åŒæ§˜ã«ã€å¿…è¦ãªå…¨ã¦ã®secretsã‚’ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦å®šç¾© ---
        # ACCOUNT1_CONSUMER_KEY: ${{ secrets.ACCOUNT1_CONSUMER_KEY }}
        # ...
        DISCORD_WEBHOOK_URL_SECRET: ${{ secrets.DISCORD_WEBHOOK_URL }}
        GOOGLE_SHEETS_KEY_JSON_SECRET: ${{ secrets.GOOGLE_SHEETS_KEY }}
        # ---
      run: |
        mkdir -p config logs
        python config/generate_config.py
        
    - name: â° Generate schedule from current time (force regenerate)
      run: python main.py --generate-schedule --date $(TZ='Asia/Tokyo' date +%Y-%m-%d) --force-regenerate

  # æŠ•ç¨¿å®Ÿè¡Œã‚¸ãƒ§ãƒ–
  post:
    # cronãƒˆãƒªã‚¬ãƒ¼ãŒ schedule ã‚¸ãƒ§ãƒ–ã¨è¢«ã‚‰ãªã„ã‚ˆã†ã«æ¡ä»¶ã‚’èª¿æ•´
    # '0 23 * * *' ä»¥å¤–ã€ã¾ãŸã¯æ‰‹å‹•å®Ÿè¡Œã§ action == 'post' ã®å ´åˆ
    if: (github.event.schedule != '0 23 * * *' && github.event.schedule != '') || (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'post')
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10' # ãƒãƒ¼ã‚¸ãƒ§ãƒ³çµ±ä¸€
        
    - name: ğŸ¬ Install FFmpeg
      run: sudo apt-get update && sudo apt-get install -y ffmpeg
      
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸ”§ Create config files from template
      env:
        # --- åŒæ§˜ã«ã€å¿…è¦ãªå…¨ã¦ã®secretsã‚’ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦å®šç¾© ---
        # ACCOUNT1_CONSUMER_KEY: ${{ secrets.ACCOUNT1_CONSUMER_KEY }}
        # ...
        DISCORD_WEBHOOK_URL_SECRET: ${{ secrets.DISCORD_WEBHOOK_URL }}
        GOOGLE_SHEETS_KEY_JSON_SECRET: ${{ secrets.GOOGLE_SHEETS_KEY }}
        # ---
      run: |
        mkdir -p config logs
        python config/generate_config.py
        
    - name: ğŸ¤– Run auto post
      run: python main.py --process-now --date $(TZ='Asia/Tokyo' date +%Y-%m-%d)
