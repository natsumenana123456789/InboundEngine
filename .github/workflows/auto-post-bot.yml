name: ðŸ¤– Auto Post Bot with Scheduler

on:
  # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œ
  schedule:
    # æ¯Žæœ8æ™‚ã«ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç”Ÿæˆï¼ˆJSTï¼‰
    - cron: '0 23 * * *'  # UTC 23:00 = JST 8:00
    # æ¯Žæ—¥10æ™‚ã€14æ™‚ã€18æ™‚ã€21æ™‚ã«æŠ•ç¨¿å®Ÿè¡Œï¼ˆJSTï¼‰
    - cron: '0 1,5,9,12 * * *'  # UTC 1,5,9,12 = JST 10,14,18,21
  
  # Git pushæ™‚ã®Slacké€šçŸ¥
  push:
    branches: [ main ]
  
  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      action:
        description: 'å®Ÿè¡Œã™ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³'
        required: true
        default: 'post'
        type: choice
        options:
          - post
          - schedule
          - schedule-now

jobs:
  # Git pushæ™‚ã®Slacké€šçŸ¥
  notify-update:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
    - name: ðŸ“¢ Git Push Slacké€šçŸ¥
      uses: 8398a7/action-slack@v3
      with:
        status: custom
        custom_payload: |
          {
            text: "ðŸ”„ ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚",
            attachments: [{
              color: "good",
              fields: [{
                title: "Repository",
                value: "${{ github.repository }}",
                short: true
              }, {
                title: "Commit",
                value: "${{ github.event.head_commit.message }}",
                short: true
              }, {
                title: "Author",
                value: "${{ github.event.head_commit.author.name }}",
                short: true
              }, {
                title: "Branch",
                value: "${{ github.ref_name }}",
                short: true
              }]
            }]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç”Ÿæˆã‚¸ãƒ§ãƒ–
  schedule:
    if: github.event.schedule == '0 23 * * *' || (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'schedule')
    runs-on: ubuntu-latest
    steps:
    - name: ðŸ“ Checkout
      uses: actions/checkout@v4
      
    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ðŸ”§ Create config files
      run: |
        mkdir -p config logs
        cat > config/config.yml << 'EOF'
        common:
          log_level: "INFO"
          file_paths:
            google_key_file: "gspread-key.json"
        twitter_api:
          bearer_token: "${{ secrets.TWITTER_BEARER_TOKEN }}"
          consumer_key: "${{ secrets.TWITTER_CONSUMER_KEY }}"
          consumer_secret: "${{ secrets.TWITTER_CONSUMER_SECRET }}"
          access_token: "${{ secrets.TWITTER_ACCESS_TOKEN }}"
          access_token_secret: "${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}"
        auto_post_bot:
          slack_webhook_url: "${{ secrets.SLACK_WEBHOOK_URL }}"
          sheet_name: "æŠ•ç¨¿ã‚¹ãƒˆãƒƒã‚¯"
          columns: ["ID", "æŠ•ç¨¿ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ", "æŠ•ç¨¿ã‚¿ã‚¤ãƒ—", "æœ€çµ‚æŠ•ç¨¿æ—¥æ™‚", "æ–‡å­—æ•°", "æœ¬æ–‡", "ç”»åƒ/å‹•ç”»URL", "æŠ•ç¨¿æ¸ˆã¿å›žæ•°"]
          twitter_accounts:
            - account_id: "jadiAngkat"
              username: "jadiAngkat"
              email: "${{ secrets.ACCOUNT1_EMAIL }}"
              consumer_key: "${{ secrets.TWITTER_CONSUMER_KEY }}"
              consumer_secret: "${{ secrets.TWITTER_CONSUMER_SECRET }}"
              access_token: "${{ secrets.TWITTER_ACCESS_TOKEN }}"
              access_token_secret: "${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}"
              google_sheets_source:
                enabled: true
                worksheet_name: "éƒ½å†…ãƒ¡ãƒ³ã‚¨ã‚¹"
            - account_id: "hinataHHHHHH"
              username: "hinataHHHHHH"
              email: "${{ secrets.ACCOUNT2_EMAIL }}"
              consumer_key: "${{ secrets.TWITTER_CONSUMER_KEY }}"
              consumer_secret: "${{ secrets.TWITTER_CONSUMER_SECRET }}"
              access_token: "${{ secrets.TWITTER_ACCESS_TOKEN }}"
              access_token_secret: "${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}"
              google_sheets_source:
                enabled: true
                worksheet_name: "éƒ½å†…ã‚»ã‚¯ã‚­ãƒ£ãƒ"
        EOF
        echo '${{ secrets.GOOGLE_SHEETS_KEY }}' > config/gspread-key.json
        
    - name: ðŸ“… Generate schedule
      run: python schedule_posts.py

  # ç¾åœ¨æ™‚åˆ»ã‹ã‚‰ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç”Ÿæˆã‚¸ãƒ§ãƒ–
  schedule-now:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'schedule-now'
    runs-on: ubuntu-latest
    steps:
    - name: ðŸ“ Checkout
      uses: actions/checkout@v4
      
    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ðŸ”§ Create config files
      run: |
        mkdir -p config logs
        cat > config/config.yml << 'EOF'
        common:
          log_level: "INFO"
          file_paths:
            google_key_file: "gspread-key.json"
        twitter_api:
          bearer_token: "${{ secrets.TWITTER_BEARER_TOKEN }}"
          consumer_key: "${{ secrets.TWITTER_CONSUMER_KEY }}"
          consumer_secret: "${{ secrets.TWITTER_CONSUMER_SECRET }}"
          access_token: "${{ secrets.TWITTER_ACCESS_TOKEN }}"
          access_token_secret: "${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}"
        auto_post_bot:
          slack_webhook_url: "${{ secrets.SLACK_WEBHOOK_URL }}"
          sheet_name: "æŠ•ç¨¿ã‚¹ãƒˆãƒƒã‚¯"
          columns: ["ID", "æŠ•ç¨¿ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ", "æŠ•ç¨¿ã‚¿ã‚¤ãƒ—", "æœ€çµ‚æŠ•ç¨¿æ—¥æ™‚", "æ–‡å­—æ•°", "æœ¬æ–‡", "ç”»åƒ/å‹•ç”»URL", "æŠ•ç¨¿æ¸ˆã¿å›žæ•°"]
          twitter_accounts:
            - account_id: "jadiAngkat"
              username: "jadiAngkat"
              email: "${{ secrets.ACCOUNT1_EMAIL }}"
              consumer_key: "${{ secrets.TWITTER_CONSUMER_KEY }}"
              consumer_secret: "${{ secrets.TWITTER_CONSUMER_SECRET }}"
              access_token: "${{ secrets.TWITTER_ACCESS_TOKEN }}"
              access_token_secret: "${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}"
              google_sheets_source:
                enabled: true
                worksheet_name: "éƒ½å†…ãƒ¡ãƒ³ã‚¨ã‚¹"
            - account_id: "hinataHHHHHH"
              username: "hinataHHHHHH"
              email: "${{ secrets.ACCOUNT2_EMAIL }}"
              consumer_key: "${{ secrets.TWITTER_CONSUMER_KEY }}"
              consumer_secret: "${{ secrets.TWITTER_CONSUMER_SECRET }}"
              access_token: "${{ secrets.TWITTER_ACCESS_TOKEN }}"
              access_token_secret: "${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}"
              google_sheets_source:
                enabled: true
                worksheet_name: "éƒ½å†…ã‚»ã‚¯ã‚­ãƒ£ãƒ"
        EOF
        echo '${{ secrets.GOOGLE_SHEETS_KEY }}' > config/gspread-key.json
        
    - name: â° Generate schedule from current time
      run: python schedule_posts.py --now

  # æŠ•ç¨¿å®Ÿè¡Œã‚¸ãƒ§ãƒ–
  post:
    if: github.event.schedule != '0 23 * * *' || (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'post')
    runs-on: ubuntu-latest
    steps:
    - name: ðŸ“ Checkout
      uses: actions/checkout@v4
      
    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: ðŸŽ¬ Install FFmpeg
      run: sudo apt-get update && sudo apt-get install -y ffmpeg
      
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ðŸ”§ Create config files
      run: |
        mkdir -p config logs
        cat > config/config.yml << 'EOF'
        common:
          log_level: "INFO"
          file_paths:
            google_key_file: "gspread-key.json"
        twitter_api:
          bearer_token: "${{ secrets.TWITTER_BEARER_TOKEN }}"
          consumer_key: "${{ secrets.TWITTER_CONSUMER_KEY }}"
          consumer_secret: "${{ secrets.TWITTER_CONSUMER_SECRET }}"
          access_token: "${{ secrets.TWITTER_ACCESS_TOKEN }}"
          access_token_secret: "${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}"
        auto_post_bot:
          slack_webhook_url: "${{ secrets.SLACK_WEBHOOK_URL }}"
          sheet_name: "æŠ•ç¨¿ã‚¹ãƒˆãƒƒã‚¯"
          columns: ["ID", "æŠ•ç¨¿ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ", "æŠ•ç¨¿ã‚¿ã‚¤ãƒ—", "æœ€çµ‚æŠ•ç¨¿æ—¥æ™‚", "æ–‡å­—æ•°", "æœ¬æ–‡", "ç”»åƒ/å‹•ç”»URL", "æŠ•ç¨¿æ¸ˆã¿å›žæ•°"]
          twitter_accounts:
            - account_id: "jadiAngkat"
              username: "jadiAngkat"
              email: "${{ secrets.ACCOUNT1_EMAIL }}"
              consumer_key: "${{ secrets.TWITTER_CONSUMER_KEY }}"
              consumer_secret: "${{ secrets.TWITTER_CONSUMER_SECRET }}"
              access_token: "${{ secrets.TWITTER_ACCESS_TOKEN }}"
              access_token_secret: "${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}"
              google_sheets_source:
                enabled: true
                worksheet_name: "éƒ½å†…ãƒ¡ãƒ³ã‚¨ã‚¹"
            - account_id: "hinataHHHHHH"
              username: "hinataHHHHHH"
              email: "${{ secrets.ACCOUNT2_EMAIL }}"
              consumer_key: "${{ secrets.TWITTER_CONSUMER_KEY }}"
              consumer_secret: "${{ secrets.TWITTER_CONSUMER_SECRET }}"
              access_token: "${{ secrets.TWITTER_ACCESS_TOKEN }}"
              access_token_secret: "${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}"
              google_sheets_source:
                enabled: true
                worksheet_name: "éƒ½å†…ã‚»ã‚¯ã‚­ãƒ£ãƒ"
        EOF
        echo '${{ secrets.GOOGLE_SHEETS_KEY }}' > config/gspread-key.json
        
    - name: ðŸ¤– Run auto post
      run: python -m bots.auto_post_bot.post_tweet 